<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bleuon.mapper.TemplateFlowchartMapper">

    <resultMap id="findMap" type="com.bleuon.entity.TemplateFlowchart" autoMapping="true">
        <id property="id" column="id"/>
        <association javaType="com.bleuon.entity.Flowchart" property="flowchart" columnPrefix="f_" autoMapping="true">
            <id property="id" column="id"/>
            <association property="user" column="{userId=user_id}" select="findUserById"/>
        </association>
    </resultMap>

    <select id="findUserById" resultType="com.bleuon.entity.Flowchart$User">
        SELECT avatar, username, id
        FROM t_users
        WHERE id = #{userId};
    </select>

    <select id="findAll" resultMap="findMap">
        SELECT tf.*,
        f.id f_id,
        f.file_name f_file_name,
        f.json f_json,
        f.data_uri f_data_uri,
        f.width f_width,
        f.height f_height,
        f.bg_color f_bg_color,
        f.grid_size f_grid_size,
        f.draw_grid f_draw_grid,
        f.router_default f_router_default,
        f.connector_default f_connector_default,
        f.is_public f_is_public,
        f.is_legal f_is_legal,
        f.is_share f_is_share,
        f.create_date f_create_date,
        f.modify_date f_modify_date,
        f.dead_share_date f_dead_share_date,
        f.user_id f_user_id
        FROM t_template_flowcharts tf
        INNER JOIN t_flowcharts f ON f.id = tf.flowchart_id
        <where>
            <trim prefix="AND" prefixOverrides="AND">
                <if test="scene != null and scene != ''">
                    AND scene = #{scene}
                </if>
                <if test="price != null and price != ''">
                    AND price = #{price}
                </if>
                <if test="ranking != null and ranking != ''">
                    AND ranking = #{ranking}
                </if>
                <if test="fileName != null and fileName != ''">
                    AND f.file_name = #{fileName}
                </if>
            </trim>
        </where>
    </select>

    <select id="findOne" resultMap="findMap">
        SELECT tf.*,
               f.id                f_id,
               f.file_name         f_file_name,
               f.json              f_json,
               f.data_uri          f_data_uri,
               f.width             f_width,
               f.height            f_height,
               f.bg_color          f_bg_color,
               f.grid_size         f_grid_size,
               f.draw_grid         f_draw_grid,
               f.router_default    f_router_default,
               f.connector_default f_connector_default,
               f.is_public         f_is_public,
               f.is_legal          f_is_legal,
               f.is_share          f_is_share,
               f.create_date       f_create_date,
               f.modify_date       f_modify_date,
               f.dead_share_date   f_dead_share_date,
               f.user_id           f_user_id
        FROM t_template_flowcharts tf
                 INNER JOIN t_flowcharts f ON f.id = tf.flowchart_id
        WHERE tf.id = #{id};
    </select>

    <update id="updateOne">
        UPDATE t_template_flowcharts
        <set>
            <trim suffixOverrides=",">
                <if test="views != null">views = #{views},</if>
                <if test="copies != null">copies = #{copies},</if>
                <if test="stars != null">stars = #{stars},</if>
                <if test="tags != null">tags = #{tags},</if>
                <if test="scene != null">scene = #{scene},</if>
                <if test="price != null">price = #{price},</if>
                <if test="ranking != null">ranking = #{ranking},</if>
                <if test="description != null">`description` = #{description},</if>
            </trim>
        </set>
        WHERE id = #{id}
    </update>

</mapper>