{"version":3,"file":"ShareFlowchart-ad499024.js","sources":["../../../apps/mainapp/views/share/ShareFlowchart.vue"],"sourcesContent":["<script lang=\"ts\" setup>\r\n/**\r\n * @description 分享的 Flowchart 流程图\r\n * @author zheng\r\n * @since 2023/9/30\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\n// jointjs css\r\nimport \"jointjs/css/layout.css\";\r\nimport \"jointjs/css/themes/default.css\";\r\n\r\nimport { dia, initJointJs } from \"@mainapp/lib\";\r\nimport { FlowchartApi } from \"@mainapp/apis\";\r\nimport { ListenerService } from \"@mainapp/service/diagraming/flowchart\";\r\nimport * as Data from \"@mainapp/data/diagraming/flowchart\";\r\nimport { DateUtil } from \"@common/utils\";\r\n\r\n// components\r\nimport HeaderToolsBottom from \"@mainapp/components/diagraming/flowchart/HeaderToolsBottom.vue\";\r\nimport HeaderToolsTop from \"@mainapp/components/diagraming/flowchart/HeaderToolsTop.vue\";\r\nimport FooterTools from \"@mainapp/components/diagraming/flowchart/FooterTools.vue\";\r\n\r\nconst paper = shallowRef<dia.Paper>();\r\nconst graph = shallowRef<dia.Graph>();\r\nconst route = useRoute();\r\nconst router = useRouter();\r\n\r\nconst flowchartData = ref<FlowchartData>({});\r\nconst textInputRef = shallowRef<HTMLInputElement>();\r\n\r\nprovide(KeyVals.BLEUON_FLOWCHART_PAPER, paper);\r\nprovide(KeyVals.BLEUON_FLOWCHART_GRAPH, graph);\r\nprovide(KeyVals.BLEUON_FLOWCHART_DATA, flowchartData);\r\nconst token = localStorage.getToken<TokenR>(KeyVals.MAINAPP_TOKEN_KEY);\r\n\r\nasync function fetchData() {\r\n  const data = await FlowchartApi.exposeFindOne({ id: route.params.id.toString() }, () => {\r\n    router.back();\r\n  });\r\n  flowchartData.value = data;\r\n}\r\n\r\nfunction regainFromJson() {\r\n  paper.value.freeze();\r\n\r\n  if (flowchartData.value.json) {\r\n    graph.value.fromJSON(JSON.parse(flowchartData.value.json));\r\n  }\r\n\r\n  paper.value.options.defaultConnector = JSON.parse(flowchartData.value.connectorDefault);\r\n  paper.value.options.defaultRouter = JSON.parse(flowchartData.value.routerDefault);\r\n\r\n  paper.value.unfreeze();\r\n}\r\n\r\nonMounted(() => {\r\n  const jointjs = initJointJs({\r\n    el: \"bleuon__flowchart-content\",\r\n    width: \"100vw\",\r\n    height: \"75vh\",\r\n    gridSize: flowchartData.value.gridSize,\r\n    bgColor: flowchartData.value.bgColor,\r\n    drawGrid: JSON.parse(flowchartData.value.drawGrid)\r\n  });\r\n\r\n  paper.value = jointjs.paper;\r\n  graph.value = jointjs.graph;\r\n\r\n  regainFromJson();\r\n\r\n  paper.value.on({\r\n    \"element:pointerclick\": view => ListenerService.onPointerClickElement(view),\r\n    \"element:pointerdblclick\": view =>\r\n      ListenerService.onPointerDbclickElement(view, textInputRef.value),\r\n    \"link:pointerclick\": view => ListenerService.onPointerClickLink(view),\r\n    \"link:pointerdblclick\": view =>\r\n      ListenerService.onPointerDbclickElement(view, textInputRef.value),\r\n    \"blank:pointerclick\": () => ListenerService.onPointerClickBlank(),\r\n    \"blank:mousewheel\": evt => ListenerService.onMousewheelBlank(evt, paper.value)\r\n  });\r\n});\r\n\r\nconst dialogVisible = ref(false);\r\n\r\nfunction replicateFlowchart() {\r\n  flowchartData.value.fileName = \"模板_\" + flowchartData.value.fileName;\r\n  FlowchartApi.replicate(flowchartData.value, res => ElMessage.success(res.message));\r\n}\r\n\r\nawait fetchData();\r\n</script>\r\n\r\n<template>\r\n  <div class=\"bleuon__flowchart-container h-100vh\">\r\n    <div\r\n      class=\"bleuon__flowchart-header h-22vh border-border-primary border-b-1 border-b-solid bg-bg-primary px-4 py-4\">\r\n      <HeaderToolsTop :data=\"flowchartData\" class=\"mb-4\">\r\n        <template #tools>\r\n          <el-tooltip content=\"分享\">\r\n            <div class=\"hover i-tabler-share mr-4\" @click=\"dialogVisible = !dialogVisible\"></div>\r\n          </el-tooltip>\r\n          <el-tooltip v-if=\"token\" content=\"导入模板\">\r\n            <div>\r\n              <div class=\"hover i-tabler-file-import\" @click=\"replicateFlowchart\"></div>\r\n            </div>\r\n          </el-tooltip>\r\n        </template>\r\n      </HeaderToolsTop>\r\n      <HeaderToolsBottom\r\n        :is-clicked-element=\"Data.isClickedElement.value\"\r\n        :is-clicked-link=\"Data.isClickedLink.value\" />\r\n    </div>\r\n    <div class=\"bleuon__flowchart-wrapper f-c-b\">\r\n      <div class=\"left\"></div>\r\n      <div class=\"right\">\r\n        <div id=\"bleuon__flowchart-content\"></div>\r\n        <FooterTools class=\"h-3vh\" />\r\n      </div>\r\n      <div class=\"bleuon__flowchart-extra\">\r\n        <input ref=\"textInputRef\" class=\"bleuon__flowchart-input absolute hidden\" type=\"text\" />\r\n      </div>\r\n    </div>\r\n    <el-dialog v-model=\"dialogVisible\" title=\"分享流程图\" width=\"40%\">\r\n      <el-form ref=\"shareFormRef\" label-position=\"right\" label-width=\"100px\">\r\n        <el-form-item label=\"状态\">流程图已经公开，点击链接浏览</el-form-item>\r\n        <el-form-item label=\"链接地址\">\r\n          <router-link :to=\"'/share/flowchart/' + flowchartData.id\">\r\n            <el-link type=\"primary\">\r\n              http://localhost:5173/#/share/flowchart/{{ flowchartData.id }}\r\n            </el-link>\r\n          </router-link>\r\n        </el-form-item>\r\n        <el-form-item label=\"截止日期\">\r\n          {{ DateUtil.formatted(\"yyyy-MM-dd HH:mm:ss\", flowchartData.deadShareDate) }}\r\n        </el-form-item>\r\n      </el-form>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n\r\n<style lang=\"scss\">\r\n.joint-element {\r\n  .joint-port {\r\n    circle {\r\n      fill: transparent;\r\n      stroke: transparent;\r\n      stroke-width: 0;\r\n      stroke-dasharray: none;\r\n    }\r\n  }\r\n}\r\n</style>\r\n"],"names":["paper","shallowRef","graph","route","useRoute","router","useRouter","flowchartData","ref","textInputRef","provide","KeyVals.BLEUON_FLOWCHART_PAPER","KeyVals.BLEUON_FLOWCHART_GRAPH","KeyVals.BLEUON_FLOWCHART_DATA","token","KeyVals.MAINAPP_TOKEN_KEY","fetchData","data","FlowchartApi.exposeFindOne","regainFromJson","onMounted","jointjs","initJointJs","view","ListenerService.onPointerClickElement","ListenerService.onPointerDbclickElement","ListenerService.onPointerClickLink","ListenerService.onPointerClickBlank","evt","ListenerService.onMousewheelBlank","dialogVisible","replicateFlowchart","FlowchartApi.replicate","res","ElMessage","__temp","__restore","_withAsyncContext"],"mappings":"6oDAuBA,MAAAA,EAAAC,IACAC,EAAAD,IACAE,EAAAC,IACAC,EAAAC,IAEAC,EAAAC,EAAA,CAAA,CAAA,EACAC,EAAAR,IAEAS,EAAAC,EAAAX,CAAA,EACAU,EAAAE,EAAAV,CAAA,EACAQ,EAAAG,EAAAN,CAAA,EACA,MAAAO,EAAA,aAAA,SAAAC,CAAA,EAEA,eAAAC,GAAA,CACE,MAAAC,EAAA,MAAAC,GAAA,CAAA,GAAAf,EAAA,OAAA,GAAA,SAAA,CAAA,EAAA,IAAA,CACEE,EAAA,KAAA,CAAY,CAAA,EAEdE,EAAA,MAAAU,CAAsB,CAGxB,SAAAE,GAAA,CACEnB,EAAA,MAAA,SAEAO,EAAA,MAAA,MACEL,EAAA,MAAA,SAAA,KAAA,MAAAK,EAAA,MAAA,IAAA,CAAA,EAGFP,EAAA,MAAA,QAAA,iBAAA,KAAA,MAAAO,EAAA,MAAA,gBAAA,EACAP,EAAA,MAAA,QAAA,cAAA,KAAA,MAAAO,EAAA,MAAA,aAAA,EAEAP,EAAA,MAAA,UAAqB,CAGvBoB,EAAA,IAAA,CACE,MAAAC,EAAAC,GAAA,CAA4B,GAAA,4BACtB,MAAA,QACG,OAAA,OACC,SAAAf,EAAA,MAAA,SACsB,QAAAA,EAAA,MAAA,QACD,SAAA,KAAA,MAAAA,EAAA,MAAA,QAAA,CACoB,CAAA,EAGnDP,EAAA,MAAAqB,EAAA,MACAnB,EAAA,MAAAmB,EAAA,MAEAF,IAEAnB,EAAA,MAAA,GAAA,CAAe,uBAAAuB,GAAAC,GAAAD,CAAA,EAC6D,0BAAAA,GAAAE,EAAAF,EAAAd,EAAA,KAAA,EAER,oBAAAc,GAAAG,GAAAH,CAAA,EACE,uBAAAA,GAAAE,EAAAF,EAAAd,EAAA,KAAA,EAEF,qBAAA,IAAAkB,GAAA,EACF,mBAAAC,GAAAC,GAAAD,EAAA5B,EAAA,KAAA,CACa,CAAA,CAC9E,CAAA,EAGH,MAAA8B,EAAAtB,EAAA,EAAA,EAEA,SAAAuB,GAAA,CACExB,EAAA,MAAA,SAAA,MAAAA,EAAA,MAAA,SACAyB,GAAAzB,EAAA,MAAA0B,GAAAC,EAAA,QAAAD,EAAA,OAAA,CAAA,CAAiF,CAGnF,OAAAE,EAAAC,CAAA,EAAAC,EAAA,IAAArB,EAAA,CAAA,EAAA,MAAAmB,EAAAC"}