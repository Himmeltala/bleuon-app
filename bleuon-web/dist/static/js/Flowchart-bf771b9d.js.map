{"version":3,"file":"Flowchart-bf771b9d.js","sources":["../../../apps/mainapp/lib/shapes/path.ts","../../../apps/mainapp/apis/api-official-cells.ts","../../../common/utils/prevent.ts","../../../apps/mainapp/components/diagraming/SVG.vue","../../../apps/mainapp/components/diagraming/flowchart/CellsForFlowchart.vue","../../../apps/mainapp/components/diagraming/flowchart/CellsForBasic.vue","../../../apps/mainapp/views/diagraming/Flowchart.vue"],"sourcesContent":["/**\r\n * @description 定义路径\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/24\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\nimport { dia, shapes } from \"jointjs\";\r\nimport { getPorts } from \"../tools\";\r\n\r\n/**\r\n * 创建 path\r\n *\r\n * @param graph\r\n * @param config\r\n */\r\nexport function create(\r\n  graph: dia.Graph,\r\n  config: {\r\n    x?: number;\r\n    y?: number;\r\n    width?: number;\r\n    height?: number;\r\n    attrs?: any;\r\n  }\r\n) {\r\n  const keys = Object.keys(config.attrs || {});\r\n  const markup = keys.map(v => ({ tagName: \"path\", selector: `${v}` }));\r\n\r\n  // @ts-ignore\r\n  const path = new shapes.bleuon.Path({\r\n    position: { x: config.x || 30, y: config.y || 30 },\r\n    ports: {\r\n      groups: getPorts()\r\n    },\r\n    attrs: { ...(config.attrs || {}) },\r\n    markup: [\r\n      ...markup,\r\n      {\r\n        tagName: \"text\",\r\n        selector: \"label\"\r\n      }\r\n    ]\r\n  });\r\n\r\n  path.resize(config.width || 140, config.height || 70);\r\n  path.addPorts([{ group: \"top\" }, { group: \"bottom\" }, { group: \"left\" }, { group: \"right\" }]);\r\n\r\n  graph.addCell(path);\r\n}\r\n","/**\r\n * @description Cell API\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/27\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\nimport request from \"./use-axios\";\r\n\r\n/**\r\n * 获取所有的 cells\r\n *\r\n * @param type 图形类型\r\n */\r\nexport async function queryAll(type: \"basic\" | \"flowchart\") {\r\n  const { data } = await request.get<R>(\"/cell/official/query/all\", { params: { type } });\r\n  return data.data;\r\n}\r\n","/**\r\n * @description 防抖函数、节流函数等\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/29\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\nexport function debounce<T extends (...args: any[]) => void>(\r\n  func: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let timer: number | undefined;\r\n\r\n  return function (this: any, ...args: Parameters<T>): void {\r\n    clearTimeout(timer);\r\n    timer = setTimeout(() => {\r\n      func.apply(this, args);\r\n    }, delay);\r\n  };\r\n}\r\n\r\nexport function throttle<T extends (...args: any[]) => void>(\r\n  func: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let lastExecTime = 0;\r\n\r\n  return function (this: any, ...args: Parameters<T>): void {\r\n    const now = Date.now();\r\n    if (now - lastExecTime >= delay) {\r\n      func.apply(this, args);\r\n      lastExecTime = now;\r\n    }\r\n  };\r\n}\r\n","<script setup lang=\"ts\">\r\n/**\r\n * @description Path SVG 创建组件\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/26\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\nimport { dia, Path } from \"@mainapp/lib\";\r\n\r\ndefineProps({\r\n  viewBox: {\r\n    type: String,\r\n    required: true\r\n  },\r\n  content: {\r\n    type: String,\r\n    required: true\r\n  },\r\n  attrs: {\r\n    type: Object,\r\n    required: true\r\n  },\r\n  width: {\r\n    type: Number,\r\n    default: 140\r\n  },\r\n  height: {\r\n    type: Number,\r\n    default: 70\r\n  },\r\n  flex: {\r\n    type: String,\r\n    default: \"0 1 15%\"\r\n  }\r\n});\r\n\r\nconst graph = inject<dia.Graph>(KeyVals.BLEUON_FLOWCHART_GRAPH);\r\n</script>\r\n\r\n<template>\r\n  <el-tooltip :content=\"content\">\r\n    <svg\r\n      :style=\"{ flex: flex }\"\r\n      :viewBox=\"viewBox\"\r\n      @click=\"\r\n        Path.create(graph, {\r\n          width,\r\n          height,\r\n          attrs\r\n        })\r\n      \"\r\n      xmlns=\"http://www.w3.org/2000/svg\">\r\n      <path\r\n        v-for=\"(v, k) in attrs\"\r\n        :key=\"k\"\r\n        :d=\"v.refD\"\r\n        :fill=\"v.fill || '#ffffff'\"\r\n        :stroke-width=\"v.stwidth || '0.3'\"\r\n        :stroke=\"v.stroke || '#333333'\"></path>\r\n    </svg>\r\n  </el-tooltip>\r\n</template>\r\n\r\n<style scoped lang=\"scss\">\r\nsvg {\r\n  --uno: w-10 h-10 object-cover cursor-pointer;\r\n}\r\n</style>\r\n","<script setup lang=\"ts\">\r\n/**\r\n * @description Flowchart 图形创建组件\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/25\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\nimport { OfficialCellsApi } from \"@mainapp/apis\";\r\nimport SVG from \"../SVG.vue\";\r\n\r\nconst data = ref(null);\r\n\r\ndata.value = await OfficialCellsApi.queryAll(\"flowchart\");\r\n</script>\r\n\r\n<template>\r\n  <div class=\"cells-for-flowchart\">\r\n    <div class=\"mb-4 text-0.8rem font-bold\">Flowchart 图形</div>\r\n    <div class=\"f-c-s flex-wrap flex-gap-3\">\r\n      <SVG\r\n        v-if=\"data.length\"\r\n        v-for=\"item in data\"\r\n        :width=\"item.width\"\r\n        :height=\"item.height\"\r\n        :content=\"item.notes\"\r\n        :view-box=\"item.viewBox\"\r\n        :attrs=\"JSON.parse(item.attrs)\"></SVG>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<style scoped lang=\"scss\"></style>\r\n","<script setup lang=\"ts\">\r\n/**\r\n * @description 基础图形创建组件\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/25\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\nimport { OfficialCellsApi } from \"@mainapp/apis\";\r\nimport SVG from \"../SVG.vue\";\r\n\r\nconst data = ref(null);\r\n\r\ndata.value = await OfficialCellsApi.queryAll(\"basic\");\r\n</script>\r\n\r\n<template>\r\n  <div class=\"cells-for-flowchart\">\r\n    <div class=\"mb-4 text-0.8rem font-bold\">基础图形</div>\r\n    <div class=\"f-c-s flex-wrap flex-gap-3\">\r\n      <SVG\r\n        v-if=\"data.length\"\r\n        v-for=\"item in data\"\r\n        :width=\"item.width\"\r\n        :height=\"item.height\"\r\n        :content=\"item.notes\"\r\n        :view-box=\"item.viewBox\"\r\n        :attrs=\"JSON.parse(item.attrs)\"></SVG>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<style scoped lang=\"scss\"></style>\r\n","<script setup lang=\"ts\">\r\n/**\r\n * @description Flowchart 流程图\r\n * @author 郑人滏 42020306\r\n * @since 2023/9/9\r\n * @link https://github.com/himmelbleu/bleuon-app\r\n */\r\n\r\n// jointjs css\r\nimport \"jointjs/css/layout.css\";\r\nimport \"jointjs/css/themes/default.css\";\r\n\r\nimport { throttle } from \"@common/utils/prevent\";\r\nimport { dia, initJointJs } from \"@mainapp/lib\";\r\nimport { getDataUri } from \"@mainapp/lib/tools\";\r\nimport { FlowchartApi } from \"@mainapp/apis\";\r\nimport * as Data from \"@mainapp/data/diagraming/flowchart\";\r\nimport { ListenerService } from \"@mainapp/service/diagraming/flowchart\";\r\n\r\n// components\r\nimport HeaderToolsBottom from \"@mainapp/components/diagraming/flowchart/HeaderToolsBottom.vue\";\r\nimport HeaderToolsTop from \"@mainapp/components/diagraming/flowchart/HeaderToolsTop.vue\";\r\nimport FooterTools from \"@mainapp/components/diagraming/flowchart/FooterTools.vue\";\r\nimport Sidebar from \"@mainapp/components/diagraming/flowchart/Sidebar.vue\";\r\n\r\nconst paper = shallowRef<dia.Paper>();\r\nconst graph = shallowRef<dia.Graph>();\r\nconst route = useRoute();\r\n\r\nconst flowchartData = ref<FlowchartData>({});\r\nconst textInputRef = shallowRef<HTMLInputElement>();\r\n\r\nprovide(KeyVals.BLEUON_FLOWCHART_PAPER, paper);\r\nprovide(KeyVals.BLEUON_FLOWCHART_GRAPH, graph);\r\nprovide(KeyVals.BLEUON_FLOWCHART_DATA, flowchartData);\r\n\r\nasync function fetchData() {\r\n  const data = await FlowchartApi.queryOne({ id: route.params.id.toString() });\r\n  flowchartData.value = data;\r\n}\r\n\r\nfunction updateFlowchartData() {\r\n  const { width, height } = paper.value.getArea();\r\n  flowchartData.value.width = width;\r\n  flowchartData.value.height = height;\r\n  flowchartData.value.id = route.params.id.toString();\r\n  flowchartData.value.json = JSON.stringify(graph.value.toJSON());\r\n  flowchartData.value.connectorDefault = JSON.stringify(Data.linkConnectorConfig.value);\r\n  flowchartData.value.routerDefault = JSON.stringify(Data.linkRouterConfig.value);\r\n  flowchartData.value.dataUri = getDataUri(paper.value, graph.value);\r\n  FlowchartApi.updateOne(flowchartData.value, () => {});\r\n}\r\n\r\nconst updateThrottle = throttle(updateFlowchartData, 3000);\r\n\r\nfunction regainFromJson() {\r\n  if (flowchartData.value.json) {\r\n    paper.value.freeze();\r\n    graph.value.fromJSON(JSON.parse(flowchartData.value.json));\r\n    paper.value.unfreeze();\r\n  }\r\n\r\n  Data.linkConnectorConfig.value = JSON.parse(flowchartData.value.connectorDefault);\r\n  Data.linkRouterConfig.value = JSON.parse(flowchartData.value.routerDefault);\r\n\r\n  paper.value.options.defaultConnector = Data.linkConnectorConfig.value;\r\n  paper.value.options.defaultRouter = Data.linkRouterConfig.value;\r\n}\r\n\r\nawait fetchData();\r\n\r\nonMounted(() => {\r\n  const jointjs = initJointJs({\r\n    el: \"bleuon__flowchart-content\",\r\n    width: \"85vw\",\r\n    height: \"75vh\",\r\n    gridSize: flowchartData.value.gridSize,\r\n    bgColor: flowchartData.value.bgColor,\r\n    drawGrid: {\r\n      name: \"doubleMesh\",\r\n      args: [\r\n        { color: \"#333333\", thickness: 1 },\r\n        { color: \"gray\", scaleFactor: 5, thickness: 5 }\r\n      ]\r\n    }\r\n  });\r\n\r\n  paper.value = jointjs.paper;\r\n  graph.value = jointjs.graph;\r\n\r\n  regainFromJson();\r\n\r\n  paper.value.on({\r\n    \"element:pointerclick\": view => {\r\n      ListenerService.onPointerClickElement(view);\r\n    },\r\n    \"element:pointerdblclick\": view => {\r\n      ListenerService.onPointerDbclickElement(view, textInputRef.value);\r\n    },\r\n    \"link:pointerclick\": view => {\r\n      ListenerService.onPointerClickLink(view);\r\n    },\r\n    \"link:pointerdblclick\": view => {\r\n      ListenerService.onPointerDbclickElement(view, textInputRef.value);\r\n    },\r\n    \"blank:pointerclick\": evt => {\r\n      ListenerService.onPointerClickBlank();\r\n    },\r\n    \"blank:mousewheel\": evt => {\r\n      ListenerService.onMousewheelBlank(evt, paper.value);\r\n    }\r\n  });\r\n\r\n  // @ts-ignore\r\n  graph.value.on(\"change\", updateThrottle);\r\n  // @ts-ignore\r\n  graph.value.on(\"add\", updateThrottle);\r\n  // @ts-ignore\r\n  graph.value.on(\"remove\", updateThrottle);\r\n\r\n  ListenerService.onKeydown({\r\n    ctrlS: updateThrottle\r\n  });\r\n});\r\n</script>\r\n\r\n<template>\r\n  <div class=\"bleuon__flowchart-container h-100vh\">\r\n    <div\r\n      class=\"bleuon__flowchart-header h-22vh border-border-primary border-b-1 border-b-solid bg-#f6f7f8 px-4 py-4\">\r\n      <HeaderToolsTop @change=\"updateThrottle\" class=\"mb-4\" />\r\n      <HeaderToolsBottom\r\n        :is-clicked-element=\"Data.isClickedElement.value\"\r\n        :is-clicked-link=\"Data.isClickedLink.value\" />\r\n    </div>\r\n    <div class=\"bleuon__flowchart-wrapper f-c-b\">\r\n      <div class=\"left\">\r\n        <Sidebar class=\"h-78vh\" />\r\n      </div>\r\n      <div class=\"right\">\r\n        <div id=\"bleuon__flowchart-content\"></div>\r\n        <FooterTools class=\"h-3vh\" />\r\n      </div>\r\n      <div class=\"bleuon__flowchart-extra\">\r\n        <input ref=\"textInputRef\" type=\"text\" class=\"bleuon__flowchart-input absolute hidden\" />\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<style lang=\"scss\">\r\n.joint-element {\r\n  .joint-port {\r\n    circle {\r\n      fill: transparent;\r\n      stroke: transparent;\r\n      stroke-width: 0;\r\n      stroke-dasharray: none;\r\n      --uno: transition-all-300;\r\n    }\r\n  }\r\n\r\n  &:hover {\r\n    .joint-port {\r\n      circle {\r\n        fill: white !important;\r\n        stroke: black;\r\n        stroke-width: 1px;\r\n        stroke-dasharray: none;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n.active [joint-selector=\"line\"] {\r\n  stroke: #4666e5;\r\n}\r\n</style>\r\n"],"names":["create","graph","config","markup","v","path","shapes.bleuon","getPorts","queryAll","type","data","request","throttle","func","delay","lastExecTime","args","now","inject","KeyVals.BLEUON_FLOWCHART_GRAPH","ref","__temp","__restore","_withAsyncContext","OfficialCellsApi.queryAll","paper","shallowRef","route","useRoute","flowchartData","textInputRef","provide","KeyVals.BLEUON_FLOWCHART_PAPER","KeyVals.BLEUON_FLOWCHART_DATA","fetchData","FlowchartApi.queryOne","updateFlowchartData","width","height","Data.linkConnectorConfig","Data.linkRouterConfig","getDataUri","FlowchartApi.updateOne","updateThrottle","regainFromJson","onMounted","jointjs","initJointJs","view","ListenerService.onPointerClickElement","ListenerService.onPointerDbclickElement","ListenerService.onPointerClickLink","evt","ListenerService.onPointerClickBlank","ListenerService.onMousewheelBlank","ListenerService.onKeydown"],"mappings":"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"}